# 댓글기능에서 어려운 점과 문제 해결

팀 블로그 프로젝트에서 댓글 및 답글 기능을 구현하며 변수 설정과 자기참조 부분에서 어려움을 겪었습니다.

## 어려운 점은

댓글기능은 사용자가 게시글에서 댓글을 작성할 수 있고 parentComment를 통해서 답글도 작성할 수 있습니다. 이를 구현하기 위해 Comment 엔티티가 자신을 참조하는 자기참조(Self-Referencing) 관계를 설정해야 했습니다.하나의 댓글이 여러 개의 답글을 가질 수 있기 때문에 OneToMany 관계로 연결하는 것이 필요했습니다.

```typescript
@Query('postId') postId: number,
    @Request() req: { user: User },
    @Body() createCommentDto: CreateCommentDto,
    @Query('commentId') commentId?: number,
```

이 과정에서 **parentCommentId**의 역할에 대한 이해가 부족했습니다. 처음에는 parentCommentId가 왜 필요한지 의문이었으나, 이 변수가 특정 댓글의 부모 댓글을 식별하는 키 역할을 한다는 것을 알게 되었습니다. 이 변수가 선택적 인자(?)로 설정된 이유도 부모 댓글이 없는 일반 댓글과 부모 댓글이 있는 답글을 모두 처리하기 위함이라는 것을 깨달았습니다.

## 이를 어떻게 바라보고 해결했냐면요

```typescript
async createComment(
    postId: number,
    userId: number,
    createCommentDto: CreateCommentDto,
    parentCommentId?: number,
  ): Promise<Comment>
```

createComment 함수에서 postId 외에 parentCommentId 인자를 추가하여 부모 댓글의 ID를 받도록 했습니다.

클라이언트에서 답글을 작성할 때는 parentCommentId를 함께 전달하고, 새로운 댓글을 작성할 때는 이 값을 생략하도록 아래와 같이 구현합니다.

일반 댓글 작성 시: parentCommentId를 보내지 않습니다.
답글 작성 시: 답글을 달고 싶은 **부모 댓글의 id**를 parentCommentId에 담아 보냅니다.

```
id (PK)	postId	content	          parentCommentId (FK)
1	      123	    첫 번째 댓글 내용	  null
2	      123	    첫 번째 답글 내용	  1
3	      123	    두 번째 답글 내용	  1
```

위와 같이 DB에 저장되는 방식입니다.

## 마무리

이렇게 하니 데이터베이스가 **'이 댓글은 저 댓글의 자식이다'**라는 관계를 명확하게 이해하게 되었고, 우리는 이 관계를 이용해 댓글과 답글을 계층적으로 보여줄 수 있었습니다.
