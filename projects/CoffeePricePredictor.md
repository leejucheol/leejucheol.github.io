# 커피 생두 가격 예측 시스템

## 1. 프로젝트 개요

-   **개발 기간**: 2025.03 ~ 2025.06
-   **기술 스택**: Pytorch, FastAPI, React
-   **프로젝트 유형**: 6인 프로젝트(대학 캡스톤 과제)
-   **맡은 역할**:
    -   프론트엔드, 서버 전체
    -   기후/경제 데이터 가공
    -   해당 데이터를 학습하여 예측하는 모델의 설계/리뷰에 참여

> **GitHub Repository URL**
>
> -   [서버 Repository](https://github.com/MJU-Capstone-2025/model-server)
> -   [UI Repository](https://github.com/MJU-Capstone-2025/web-ui)
> -   [모델 설명 Repository](https://github.com/MJU-Capstone-2025/Coffee_Price_Prediction)

## 2. 프로젝트 배경

본 프로젝트는 커피 재배 지역의 기후 데이터, 거시 경제 지표, 뉴스 기사 데이터를 복합적으로 분석하여 1주/2주 **커피 선물(Coffee C) 가격을 예측**하는 시스템이다.

최근 기후변화와 경제적 불확실성으로 인한 커피 시장의 가격 변동성 증가 문제에 대응하고자 한다. 주요 목적은 **원두 구매 업체들이 최적의 구매 시점을 파악하여 비용 효율성을 높일 수 있도록 지원**하는 것이다.

궁극적으로 이 프로젝트는 공급망 내 가격 충격을 완화하여 **소비자에게 전가되는 커피 가격 인상을 방어**하는 데 기여할 것으로 예상되어 진행하게 되었다.

## 3. 프로젝트 주요 기능

### 3-1. 기후/경제 데이터를 활용하여 예측된 가격을 그래프로 보여준다:

![커피가격 예측 그래프 이미지](https://github.com/1Dohyeon/Projects/blob/main/imgs/%EC%BB%A4%ED%94%BC%EA%B0%80%EA%B2%A9%20%EC%98%88%EC%B8%A1%20%EA%B7%B8%EB%9E%98%ED%94%84%20%EC%9D%B4%EB%AF%B8%EC%A7%80.png?raw=true)

2주~1년 버튼은 하나의 화면상 그래프의 최대 X축 비율을 조절하는 기능이다. 실제 가격과 7일, 14일 예측 가격을 한눈에 비교할 수 있다. 구매 및 경고 신호는 신뢰도 검증만 진행하였으며 UI에는 구현하지 않았다. 검증을 통해 수익성을 확인하였으며, 그 결과는 **5-5**에서 확인할 수 있다.

### 3-2. 감성 분석 모델이 분류한 기사들을 링크와 함께 보여준다:

![뉴스 기사 조회](https://github.com/1Dohyeon/Projects/blob/main/imgs/%EB%89%B4%EC%8A%A4%20%EA%B8%B0%EC%82%AC%20%EC%A1%B0%ED%9A%8C.png?raw=true)

감성 분석 모델의 결과는 UI에서 중립 감성을 제외하고 상승 및 하락 예측 결과만을 필터링하여 표시하였다. 각 뉴스 기사의 타이틀을 클릭하면 해당 기사의 원본 URL로 이동할 수 있도록 구성하였다. 전체 기사 목록은 최신순으로 정렬되어 있어 최근 시장 동향을 우선적으로 확인할 수 있도록 하였다.

## 4. 현재 구현 상태

본 프로젝트의 최종 목표는 실시간 데이터를 수집하여 당일 기준 미래 가격을 예측하는 시스템 구축이다. 그러나 개발 과정에서 몇 가지 데이터 접근성 문제가 확인되었다. 일부 데이터는 유료 서비스로만 제공되며, 특히 거시 경제 지표는 실시간 수집에 상당한 제약이 있었다.

이러한 한계를 고려하여 현재는 **이미 확보된 데이터를 기반으로 학습 및 테스트 데이터셋을 구성**하였다. 아울러 **추후 실시간 데이터 수집이 가능해지는 상황에 대비**하여 모델 아키텍처를 유연하게 설계하였다. 따라서 현 단계에서는 모든 계획된 데이터를 활용하지는 않고, 뉴스 기사 데이터, 기후 데이터와 함께 경제 지표 중에서는 환율 및 유가 정보만을 선별적으로 모델에 반영하였다.

LSTM + Attention 메커니즘을 활용하여 재배 지역의 기후와 경제 데이터로 모델 학습을 진행하였으며, 모델은 7일/14일 예측 결과를 반환한다. 모델에 대한 설명은 다음 챕터에서 자세히 설명한다.

또한 뉴스 기사 데이터 기반 감성 분석 모델도 독립적으로 개발하였다. 해당 모델의 경우 90%은 기사 내용이 중립으로 분류되어 최종 서비스에서는 참고 지표로만 활용되었다. 즉, **예측된 가격 시각화에는 LSTM + Attention 메커니즘을 활용한 모델만 사용**되었다.

## 5. 기후/경제 데이터로 학습한 모델

### 5-1. 데이터 수집 및 가공

우선, NASA 기후 데이터와 yfinance를 활용하여 기후 및 경제 데이터를 수집하였다. 이때 **커피 재배 주요국인 브라질, 콜롬비아, 에티오피아의 기후 데이터만을 수집**하였다.

기후 데이터와 거시 경제 데이터를 하나의 테이블로 통합하는 작업을 수행하였다. 그러나 기후 데이터는 일별 단위인 반면, 거시 경제 데이터는 월별 또는 연도별로 구성되어 있어 해상도 차이의 문제가 있었다. 이러한 차이를 보완하기 위해, 월/연도 단위 데이터를 단순히 일별로 복제하여 직선적으로 표현하는 대신, **스플라인 보간(Spline interpolation) 기법을 활용**하여 보다 자연스러운 곡선 형태로 변환하였다.

### 5-2. 파생 변수 생성

기후/경제 데이터뿐 아니라 다음과 같이 파생 변수를 생성하였다:

-   `Coffee_Price_Return`: 일간 수익률
-   `abs_return`: 절대 수익률 크기
-   `volatility_5d/10d`: 최근 5/10일간 변동성
-   `momentum_1d/3d/5d`: 최근 1, 3, 5일간 순가격 상승폭
-   `bollinger_width`: 상대 변동성
-   `volatility_ratio`: 단기/중기 변동성 비율

또한 재배지역명 `PRECTOTCORR_harvets_mean`(재배지역별 비수확기 강수량 평균) 파생변수를 생성하였다. 이는 매 수확기 이전의 기후 상태를 반영하여 **직전 비수확기 동안의 평균 강수량을 정적 변수로 저장하여 사용**한 것이다.

### 5-3. 모델 설명(설계/리뷰에 참여)

**LSTM 구조에 Attention 메커니즘을 결합**함으로써, 시계열 데이터 내 예측에 중요한 정보를 보다 효과적으로 추출할 수 있도록 구성하였다. 기존 LSTM이 마지막 hidden state를 기반으로 예측을 수행하는 반면, Attention은 시퀀스 전반에서 중요도에 따라 가중치를 부여하여 가격 예측의 정밀도를 높이는 데 기여하였다.

입력 시퀀스는 기본적으로 예측일 이전 **100일치 데이터**로 설정하였으며, 각 입력 시퀀스에 대해 **7일 및 14일 예측**을 각각 수행하였다. 두 모델은 상호 보완적으로 활용되어, **단기 이상 징후에 대한 선제 대응**과 **중기적 추세 판단**을 모두 가능하게 하는 것을 목표로 하였다.

기존 목표는 장기적인 가격 흐름을 예측하는 것이었다. 실제로는 **상승·하락세는 어느 정도 예측 가능했지만, 급격한 변동성은 모델이 제대로 반영하지 못하는 한계**가 있었다. 이에 따라 논의를 통해 예측 기간을 7일과 14일로 분리하고, 두 모델을 **병렬적으로 운용**하는 전략으로 전환하였다.

모델 예측 결과는 다음과 같다:
![모델 예측 결과](https://github.com/1Dohyeon/Projects/blob/main/imgs/%EB%AA%A8%EB%8D%B8%20%EC%98%88%EC%B8%A1%20%EA%B2%B0%EA%B3%BC.png?raw=true)

### 5-4. 모델 검증

-   **7일 예측 모델 성능** **>** 14일 예측 모델 성능
-   **7일**:
    -   RMSE: 9.1426
    -   MAE: 6.6435
-   **14일**:
    -   RMSE: 12.9053
    -   MAE: 8.9388

> 기존에는 2개월 이상의 장기간 예측을 목표로 하였으나, 장기간 예측시 급격한 변화를 감지하지 못하는 문제가 발생하였다. 따라서 단기간(7일/14일)을 예측하되 수익을 낼 수 있을 지 검증을 추가 진행하였다. (예측 분기를 감지로 Buy 신호를 발생했을 경우 이후 수익을 검증)

### 5-5 예측 분기 감지(리뷰 참여만 하였음)

**최근 4일 평균 대비 예측값이 각각 +0.7% 이상 상승**할 경우 ‘Buy’ 신호를 발생시키는 규칙 기반 전략을 설정하였다. 해당 신호는 실제 매매로 연결하지 않고 **검증 단계까지만 진행**하였다.

또한 두 예측(7일, 14일) 간 차이가 커질 때 예측 불일치 구간으로 판단하였다. 분기 신호는 확정된 매수/회피 판단이 아닌 보수적 접근 또는 판단 보류를 유도하는 경고성 보조 시그널이다. 사용자가 판단하려는 시점이 임계값을 넘은 시점이라면 예측 결과에 대해 보수적인 판단을 진행한다. 빨간 점선 초과 시 단기 예측이 과도하게 높다고 판단하며, 파란 점선 하회 시 단기 예측이 과도하게 낮다고 판단한다.

![두 모델 예측 방향 반대](https://github.com/1Dohyeon/Projects/blob/main/imgs/%EB%91%90%20%EB%AA%A8%EB%8D%B8%20%EC%98%88%EC%B8%A1%20%EB%B0%A9%ED%96%A5%20%EB%B0%98%EB%8C%80.png?raw=true)

Buy 신호가 발생한 시점에 매수하고 이를 일주일 보유했을 때의 누적 수익률이 어떻게 변하는지 시간 순서대로 시각화하면 다음과 같다.

![수익률](https://github.com/1Dohyeon/Projects/blob/main/imgs/%EC%88%98%EC%9D%B5%EB%A5%A0.png?raw=true)

## 6. 감성 분석 모델(리뷰 참여만 하였음)

수집된 기사의 title 정보를 활용하여 키워드 기반 필터링으로 생두 가격과 연관된 문장을 선별하였다. 이후 FinBERT를 활용하여 각 문장의 감성을 분류하고 수치화된 점수를 날짜별로 집계하였다. 이렇게 생성된 감성 feature는 커피 가격 등의 정형 데이터와 결합하여 예측 모델의 입력 테이블로 활용하였다.

## 7. 모델 서버: FastAPI(직접 구현)

위 5번에서 개발한 모델을 서버에 서빙하였으며, 모델의 결과는 시계열 LSTM 모델의 7일 결과, 14일 결과 두 가지를 반환한다. `/prediction-dev` 엔드포인트를 통해 예측 결과를 조회할 수 있으며, 각 예측 결과는 날짜(Date), 예측 가격(Predicted_Price), 실제 가격(Actual_Price)을 포함한다. 7일과 14일 예측 결과를 동시에 제공하여 다양한 기간의 예측 성능을 비교할 수 있도록 구성하였다. 데이터베이스는 따로 사용하지 않고 모델의 결과를 CSV로 저장한 후, FastAPI 프레임워크를 활용하여 조회하였다.

감성 분석 모델 결과도 `/news` 엔드포인트를 통해 조회할 수 있다. 기사의 title, URL, date, 감성 분석 결과(rise, neutral, fall) 외에도 데이터를 같이 반환한다. 시스템 UI에서는 언급한 특성들만 활용한다.

## 8. UI: React(직접 구현)

> **"3. 프로젝트 주요 기능"**에서 설명

## 9. 성과 및 배운 점

-   시계열 예측 모델 및 감성 분석 모델 개발 실습
-   ML 모델을 실서비스에 통합하는 MLOps 개념 및 FastAPI 기반 서빙 경험
-   데이터 전처리 자동화와 배치 처리 개념 이해

## 10. 회고
